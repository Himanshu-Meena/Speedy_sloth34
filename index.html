<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TO-DO with Firebase Auth</title>
    <style>
        /* General Body Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Authentication Container --- */
        #auth-container {
            width: 100%;
            max-width: 400px;
            background-color: #ffffff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            text-align: center;
        }

        #auth-container h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #212529;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ced4da;
            font-size: 16px;
        }

        .auth-form button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: #4c6ef5;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .auth-form button:hover {
            background-color: #3b5bdb;
        }

        .form-switch-link, .forgot-password-link {
            color: #4c6ef5;
            text-decoration: none;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        .form-switch-link:hover, .forgot-password-link:hover {
            text-decoration: underline;
        }
        
        #auth-error {
            color: #e74c3c;
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
        }

        /* Hide forms that are not active */
        #signup-form, #forgot-password-form {
            display: none;
        }

        /* --- Main App Styles --- */
        #app-container {
            display: none; /* Initially hidden */
            width: 100%;
        }

        header {
            width: 100%;
            max-width: 800px;
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #logout-btn {
            background-color: #6c757d;
        }
        #logout-btn:hover {
            background-color: #5a6268;
        }

        h1 {
            color: #212529;
            letter-spacing: 1px;
            font-weight: 300;
            margin: 0 auto; /* Center the title */
        }

        main {
            width: 100%;
            max-width: 800px;
        }

        section {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        section:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        h2 {
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 15px;
            margin-top: 0;
            font-weight: 600;
        }

        input[type="text"],
        input[type="date"],
        select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ced4da;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #4c6ef5;
            box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.2);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: #4c6ef5;
            color: white;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: #3b5bdb;
            transform: translateY(-1px);
        }

        .deadline-inputs { display: flex; gap: 10px; margin-bottom: 15px; }
        #topic-input { flex-grow: 1; }
        #deadline-input { width: auto; }

        .quick-add-btns { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .quick-add-btns button { background-color: #adb5bd; }
        .quick-add-btns button:hover { background-color: #939aa1; }
        #add-deadline-btn { width: 100%; }

        #checklist-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        #checklist-controls input[type="text"] { flex-grow: 1; width: auto; }

        #subjects-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .subject-column { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; }
        .subject-column h3 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #dee2e6; color: #495057; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        .subject-column ul { list-style: none; padding: 0; }
        .subject-column li, #deadline-list li { padding: 12px; border-bottom: none; display: flex; justify-content: flex-start; align-items: center; gap: 12px; cursor: pointer; background-color: #ffffff; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .subject-column li:hover, #deadline-list li:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .deadline-color-circle { width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); transition: transform 0.2s ease; }
        .deadline-color-circle:hover { transform: scale(1.1); }

        .delete-btn, .delete-subject-btn { background: none; border: none; color: #e74c3c; font-size: 1.2em; font-weight: bold; cursor: pointer; padding: 0 5px; transition: color 0.2s ease; }
        .delete-btn { margin-left: auto; }
        .delete-btn:hover, .delete-subject-btn:hover { color: #c0392b; }
        .completed { text-decoration: line-through; color: #b0b0b0; }

        .custom-color-picker { display: none; position: absolute; background-color: white; border: 1px solid #ced4da; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 10px; grid-template-columns: repeat(4, 1fr); gap: 8px; z-index: 100; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 1px solid #eee; transition: transform 0.2s ease; }
        .color-swatch:hover { transform: scale(1.1); }

        #calendar-container { padding: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-header h3 { margin: 0; font-size: 1.5em; font-weight: 600; }
        .calendar-header button { padding: 8px 12px; }
        .calendar-grid, .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .calendar-weekdays div { font-weight: bold; padding-bottom: 10px; color: #6c757d; }
        .calendar-grid div { background-color: #f8f9fa; border: 2px solid transparent; border-radius: 8px; aspect-ratio: 1 / 1; position: relative; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .calendar-grid div > span.date-number { position: absolute; top: 5px; right: 7px; font-size: 0.85em; font-weight: 500; z-index: 2; }
        .task-indicators { position: absolute; bottom: 3px; left: 5px; width: auto; height: auto; display: flex; flex-direction: column; justify-content: flex-end; align-items: flex-start; padding: 0; box-sizing: border-box; gap: 3px; z-index: 1; }
        .task-line { width: 4px; left: 2px; bottom: 8px; height: 15%; border-radius: 2px; }
        .task-dot-container { position: absolute; bottom: 0px; left: 5px; display: flex; flex-wrap: wrap; gap: 3px; max-width: 80%; z-index: 1; }
        .task-dot { width: 6px; height: 6px; left: 3px; border-radius: 50%; }
        .calendar-grid .empty-day { background-color: transparent; border: none; box-shadow: none; }
        .calendar-grid .current-day { border-color: #4c6ef5; }
        .calendar-grid .completed-border { border-color: #28a745; }
        .calendar-grid .missed-border { border-color: #dc3545; }
        .calendar-grid .current-day.completed-border { border-color: #28a745; }
        .calendar-grid .has-completed-tasks::after { content: 'âœ”'; position: absolute; bottom: 5px; right: 5px; font-size: 14px; font-weight: bold; color: #28a745; z-index: 2; }
    </style>
</head>
<body>

    <!-- Authentication Section -->
    <div id="auth-container">
        <!-- Login Form -->
        <form id="login-form" class="auth-form">
            <h2>Login</h2>
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Login</button>
            <p id="auth-error"></p>
            <a class="form-switch-link" id="show-signup">Don't have an account? Sign Up</a>
            <a class="forgot-password-link" id="show-forgot-password">Forgot Password?</a>
        </form>

        <!-- Signup Form -->
        <form id="signup-form" class="auth-form">
            <h2>Sign Up</h2>
            <input type="email" id="signup-email" placeholder="Email" required>
            <input type="password" id="signup-password" placeholder="Password" required>
            <button type="submit">Sign Up</button>
            <a class="form-switch-link" id="show-login">Already have an account? Login</a>
        </form>
        
        <!-- Forgot Password Form -->
        <form id="forgot-password-form" class="auth-form">
            <h2>Reset Password</h2>
            <input type="email" id="reset-email" placeholder="Enter your email" required>
            <button type="submit">Send Reset Link</button>
            <a class="form-switch-link" id="back-to-login">Back to Login</a>
        </form>
    </div>

    <!-- Main App Content (Initially Hidden) -->
    <div id="app-container">
        <header>
            <h1>My Study Tracker</h1>
            <button id="logout-btn">Logout</button>
        </header>
        <main>
            <section id="checklist">
                <h2>Checklist</h2>
                <div id="checklist-controls">
                    <button id="add-subject-btn">Add Subject</button>
                    <input type="text" id="task-input" placeholder="New task...">
                    <select id="subject-select"></select>
                    <button id="add-task-btn">Add Task</button>
                </div>
                <div id="subjects-container"></div>
            </section>
            <section id="deadlines">
                <h2>Current Tasks</h2>
                <div class="deadline-inputs">
                    <input type="text" id="topic-input" placeholder="Add new topic">
                    <input type="date" id="deadline-input">
                </div>
                <div class="quick-add-btns">
                    <button id="add-today-btn">Today</button>
                    <button id="add-tomorrow-btn">Tomorrow</button>
                    <button id="add-week-btn">Next Week</button>
                    <button id="add-month-btn">Next Month</button>
                </div>
                <button id="add-deadline-btn">Add Deadline with Date</button>
                <ul id="deadline-list"></ul>
            </section>
            <section id="regularity">
                <h2>Calendar</h2>
                <div id="calendar-container">
                    <div class="calendar-header">
                        <button id="prev-month-btn">&lt;</button>
                        <h3 id="month-year-display"></h3>
                        <button id="next-month-btn">&gt;</button>
                    </div>
                    <div class="calendar-weekdays">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendar-days" class="calendar-grid"></div>
                </div>
            </section>
        </main>
    </div>
    
    <div id="custom-color-picker" class="custom-color-picker"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhLpiJy3IhrG5xvWoo1Vmb3QQC57Aq-34",
            authDomain: "speedystodobe.firebaseapp.com",
            projectId: "speedystodobe",
            storageBucket: "speedystodobe.firebasestorage.app",
            messagingSenderId: "484792062191",
            appId: "1:484792062191:web:cfa0de0909a65fe6824b1a",
            measurementId: "G-K7M50S4KMK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');

        // --- Form Switching Logic ---
        document.getElementById('show-signup').addEventListener('click', () => {
            loginForm.style.display = 'none';
            forgotPasswordForm.style.display = 'none';
            signupForm.style.display = 'block';
            authError.textContent = '';
        });
        document.getElementById('show-login').addEventListener('click', () => {
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
            authError.textContent = '';
        });
        document.getElementById('show-forgot-password').addEventListener('click', () => {
            loginForm.style.display = 'none';
            forgotPasswordForm.style.display = 'block';
            authError.textContent = '';
        });
        document.getElementById('back-to-login').addEventListener('click', () => {
            forgotPasswordForm.style.display = 'none';
            loginForm.style.display = 'block';
            authError.textContent = '';
        });

        // --- Authentication Logic ---

        // Sign Up
        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    console.log('User signed up:', userCredential.user);
                    // The onAuthStateChanged listener will handle showing the app
                })
                .catch(error => {
                    authError.textContent = error.message;
                });
        });

        // Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    console.log('User logged in:', userCredential.user);
                    // The onAuthStateChanged listener will handle showing the app
                })
                .catch(error => {
                    authError.textContent = error.message;
                });
        });
        
        // Forgot Password
        forgotPasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    alert('Password reset email sent! Check your inbox.');
                    forgotPasswordForm.style.display = 'none';
                    loginForm.style.display = 'block';
                    authError.textContent = '';
                })
                .catch(error => {
                    authError.textContent = error.message;
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log('User signed out.');
                // The onAuthStateChanged listener will handle hiding the app
            });
        });
        
        // --- Auth State Observer ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                // Initialize the main application logic for the logged-in user
                initializeAppLogic(user);
            } else {
                // User is signed out.
                appContainer.style.display = 'none';
                authContainer.style.display = 'block';
            }
        });


        // --- Main Application Logic (wrapped in a function) ---
        function initializeAppLogic(user) {
            // This function contains all your original script.js code.
            // It's called only when a user is logged in.
            
            // --- App DOM Elements ---
            const topicInput = document.getElementById('topic-input');
            const deadlineInput = document.getElementById('deadline-input');
            const addDeadlineBtn = document.getElementById('add-deadline-btn');
            const deadlineList = document.getElementById('deadline-list');
            const addTodayBtn = document.getElementById('add-today-btn');
            const addTomorrowBtn = document.getElementById('add-tomorrow-btn');
            const addWeekBtn = document.getElementById('add-week-btn');
            const addMonthBtn = document.getElementById('add-month-btn');
            const customColorPicker = document.getElementById('custom-color-picker');
            const addSubjectBtn = document.getElementById('add-subject-btn');
            const taskInput = document.getElementById('task-input');
            const subjectSelect = document.getElementById('subject-select');
            const addTaskBtn = document.getElementById('add-task-btn');
            const subjectsContainer = document.getElementById('subjects-container');
            const monthYearDisplay = document.getElementById('month-year-display');
            const calendarDays = document.getElementById('calendar-days');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');

            const colorPalette = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff'];
            
            // --- Data Initialization from Firestore ---
            let deadlines = [];
            let subjects = [];
            let completedDates = [];
            
            // Reference to the user's document in Firestore
            const userDocRef = db.collection('users').doc(user.uid);

            // Listen for real-time updates from Firestore
            userDocRef.onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    deadlines = data.deadlines || [];
                    subjects = data.subjects || [{ name: 'General', tasks: [] }];
                    completedDates = data.completedDates || [];
                } else {
                    // If the user is new, create their document
                    console.log("No data found, creating new user document.");
                    deadlines = [];
                    subjects = [{ name: 'General', tasks: [] }];
                    completedDates = [];
                    save(); // Save the initial empty state
                }
                renderAll(); // Re-render the entire UI with the new data
            });

            let currentDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();

            // --- Save Function (to Firestore) ---
            function save() {
                userDocRef.set({
                    deadlines: deadlines,
                    subjects: subjects,
                    completedDates: completedDates
                }).catch(error => console.error("Error saving to Firestore: ", error));
            }
            
            function formatDate(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function showColorPicker(event, deadlineIndex) {
                customColorPicker.innerHTML = '';
                customColorPicker.style.display = 'grid';
                const rect = event.target.getBoundingClientRect();
                customColorPicker.style.top = `${rect.bottom + window.scrollY + 5}px`;
                customColorPicker.style.left = `${rect.left + window.scrollX}px`;

                colorPalette.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = color;
                    swatch.onclick = () => {
                        deadlines[deadlineIndex].color = color;
                        save();
                        // Firestore listener will handle re-rendering
                        hideColorPicker();
                    };
                    customColorPicker.appendChild(swatch);
                });

                setTimeout(() => { document.addEventListener('click', hideColorPicker, { once: true }); }, 0);
                event.stopPropagation();
            }

            function hideColorPicker(event) {
                if (event && customColorPicker.contains(event.target)) {
                    document.addEventListener('click', hideColorPicker, { once: true });
                    return;
                }
                customColorPicker.style.display = 'none';
            }
            
            function renderDeadlines() {
                deadlineList.innerHTML = '';
                deadlines.forEach((deadline, index) => {
                    const li = document.createElement('li');
                    const colorCircle = document.createElement('span');
                    colorCircle.className = 'deadline-color-circle';
                    colorCircle.style.backgroundColor = deadline.color;
                    colorCircle.addEventListener('click', (e) => showColorPicker(e, index));
                    li.appendChild(colorCircle);

                    const textSpan = document.createElement('span');
                    textSpan.textContent = `${deadline.topic} - ${deadline.date}`;
                    li.appendChild(textSpan);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'âœ–';
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteDeadline(index); };
                    li.appendChild(deleteBtn);
                    deadlineList.appendChild(li);
                });
            }

            function createAndAddDeadline(topic, dateString) {
                if (topic && dateString) {
                    const newColor = colorPalette[deadlines.length % colorPalette.length];
                    deadlines.push({ topic, date: dateString, color: newColor });
                    deadlines.sort((a, b) => new Date(a.date) - new Date(b.date));
                    topicInput.value = '';
                    deadlineInput.value = '';
                    save();
                } else {
                    alert('Please provide a topic and select a date.');
                }
            }

            function addDeadline() { createAndAddDeadline(topicInput.value.trim(), deadlineInput.value); }
            
            function addQuickDeadline(period) {
                const topic = topicInput.value.trim();
                if (!topic) { alert('Please enter a topic first.'); return; }
                const date = new Date();
                if (period === 'tomorrow') date.setDate(date.getDate() + 1);
                else if (period === 'week') date.setDate(date.getDate() + 7);
                else if (period === 'month') date.setMonth(date.getMonth() + 1);
                createAndAddDeadline(topic, formatDate(date));
            }

            function deleteDeadline(index) {
                deadlines.splice(index, 1);
                save();
            }

            function renderSubjects() {
                subjectsContainer.innerHTML = '';
                subjectSelect.innerHTML = '';
                if (subjects.length === 0) {
                    subjectSelect.innerHTML = '<option disabled>No subjects available</option>';
                    return;
                }
                subjects.forEach((subject, subjectIndex) => {
                    const option = document.createElement('option');
                    option.value = subjectIndex;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                    const column = document.createElement('div');
                    column.className = 'subject-column';
                    const header = document.createElement('h3');
                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = subject.name;
                    header.appendChild(titleSpan);
                    const deleteSubBtn = document.createElement('button');
                    deleteSubBtn.textContent = 'ðŸ—‘ï¸';
                    deleteSubBtn.className = 'delete-subject-btn';
                    deleteSubBtn.title = `Delete ${subject.name} subject`;
                    deleteSubBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`Are you sure you want to delete "${subject.name}"?`)) {
                            deleteSubject(subjectIndex);
                        }
                    });
                    header.appendChild(deleteSubBtn);
                    column.appendChild(header);
                    const ul = document.createElement('ul');
                    if (subject.tasks) { // Ensure tasks array exists
                        subject.tasks.forEach((task, taskIndex) => {
                            const li = document.createElement('li');
                            if (task.completed) li.classList.add('completed');
                            const taskText = document.createElement('span');
                            taskText.textContent = task.text;
                            li.appendChild(taskText);
                            li.addEventListener('click', () => toggleTask(subjectIndex, taskIndex));
                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'âœ–';
                            deleteBtn.className = 'delete-btn';
                            deleteBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                deleteTask(subjectIndex, taskIndex);
                            });
                            li.appendChild(deleteBtn);
                            ul.appendChild(li);
                        });
                    }
                    column.appendChild(ul);
                    subjectsContainer.appendChild(column);
                });
            }

            function addSubject() {
                const name = prompt('Enter the new subject name:');
                if (name && name.trim()) {
                    subjects.push({ name: name.trim(), tasks: [] });
                    save();
                }
            }
            
            function deleteSubject(subjectIndex) {
                subjects.splice(subjectIndex, 1);
                save();
            }

            function addTask() {
                const text = taskInput.value.trim();
                const subjectIndex = subjectSelect.value;
                if (text && subjectIndex !== null && subjects[subjectIndex]) {
                    if (!subjects[subjectIndex].tasks) {
                        subjects[subjectIndex].tasks = []; // Initialize if it doesn't exist
                    }
                    subjects[subjectIndex].tasks.push({ text, completed: false });
                    taskInput.value = '';
                    save();
                }
            }

            function deleteTask(subjectIndex, taskIndex) {
                subjects[subjectIndex].tasks.splice(taskIndex, 1);
                save();
            }

            function toggleTask(subjectIndex, taskIndex) {
                const task = subjects[subjectIndex].tasks[taskIndex];
                task.completed = !task.completed;
                const todayString = formatDate(new Date());
                if (task.completed) {
                    if (!completedDates.includes(todayString)) completedDates.push(todayString);
                } else {
                    const allTasks = subjects.flatMap(s => s.tasks);
                    const anyCompletedToday = allTasks.some(t => t.completed && completedDates.includes(todayString));
                    if (!anyCompletedToday) {
                        const index = completedDates.indexOf(todayString);
                        if (index > -1) completedDates.splice(index, 1);
                    }
                }
                save();
            }

            function renderCalendar() {
                calendarDays.innerHTML = '';
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                monthYearDisplay.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`;

                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarDays.appendChild(document.createElement('div')).classList.add('empty-day');
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'date-number';
                    dayNumber.textContent = day;
                    dayCell.appendChild(dayNumber);

                    const cellDate = new Date(currentYear, currentMonth, day);
                    cellDate.setHours(0,0,0,0);
                    const today = new Date();
                    today.setHours(0,0,0,0);

                    const cellDateString = formatDate(cellDate);
                    const hasCompletedTasks = completedDates.includes(cellDateString);

                    if (cellDate.getTime() === today.getTime()) {
                        dayCell.classList.add('current-day');
                        if (hasCompletedTasks) dayCell.classList.add('completed-border');
                    } else if (cellDate < today) {
                        if (hasCompletedTasks) dayCell.classList.add('completed-border');
                        else dayCell.classList.add('missed-border');
                    } else {
                        if (hasCompletedTasks) dayCell.classList.add('completed-border');
                    }
                    if (hasCompletedTasks) dayCell.classList.add('has-completed-tasks');

                    const activeTasks = deadlines.filter(d => {
                        const deadlineDate = new Date(d.date);
                        deadlineDate.setHours(23, 59, 59, 999); 
                        return cellDate >= today && cellDate <= deadlineDate;
                    });

                    if (activeTasks.length > 0) {
                        if (activeTasks.length <= 4) {
                            const indicators = document.createElement('div');
                            indicators.className = 'task-indicators';
                            activeTasks.forEach(task => {
                                const line = document.createElement('div');
                                line.className = 'task-line';
                                line.style.backgroundColor = task.color;
                                indicators.appendChild(line);
                            });
                            dayCell.appendChild(indicators);
                        } else {
                            const dotContainer = document.createElement('div');
                            dotContainer.className = 'task-dot-container';
                            activeTasks.slice(0, 8).forEach(task => {
                                const dot = document.createElement('div');
                                dot.className = 'task-dot';
                                dot.style.backgroundColor = task.color;
                                dotContainer.appendChild(dot);
                            });
                            dayCell.appendChild(dotContainer);
                        }
                    }
                    calendarDays.appendChild(dayCell);
                }
            }

            function changeMonth(offset) {
                currentMonth += offset;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; } 
                else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar();
            }

            function renderAll() {
                renderDeadlines();
                renderSubjects();
                renderCalendar();
            }

            // --- Event Listeners ---
            addDeadlineBtn.addEventListener('click', addDeadline);
            addTodayBtn.addEventListener('click', () => addQuickDeadline('today'));
            addTomorrowBtn.addEventListener('click', () => addQuickDeadline('tomorrow'));
            addWeekBtn.addEventListener('click', () => addQuickDeadline('week'));
            addMonthBtn.addEventListener('click', () => addQuickDeadline('month'));
            addSubjectBtn.addEventListener('click', addSubject);
addTaskBtn.addEventListener('click', addTask);
            prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            nextMonthBtn.addEventListener('click', () => changeMonth(1));
        }
    </script>
</body>
</html>
